#!/bin/bash
script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
benchmark_name=$(echo $script_dir | rev | cut -d "/" -f 4 | rev)
project_name=$(echo $script_dir | rev | cut -d "/" -f 3 | rev)
bug_id=$(echo $script_dir | rev | cut -d "/" -f 2 | rev)
dir_name=/experiment/$benchmark_name/$project_name/$bug_id

cd $dir_name/src
cp $script_dir/bug.json $dir_name/bug.json
cp $script_dir/../poc/poc2.c $dir_name/src/poc.c

./autogen.sh --enable-static --without-threads --without-thread-alloc --with-threads=no --with-thread-alloc=no CFLAGS="-g -D__NO_STRING_INLINES  -D_FORTIFY_SOURCE=0 -U__OPTIMIZE__ "

sed -i 's/fabs/fabs_crepair/g' ./xmlschemastypes.c
sed -i 's/fabs/fabs_crepair/g' ./xpath.c
git config --global user.email "you@example.com"
git config --global user.name "Your Name"
git add  ./xmlschemastypes.c ./xpath.c
git commit -m 'replace fabs with proxy function'

./configure CFLAGS='-g -O0' --enable-static --disable-shared --without-threads
# add driver to MakeFile
line_number=$(grep -n -m1 Makefile -e ".SUFFIXES:"  | cut -f1 -d:)
sed -i "${line_number}i driver: all\n\t\$(CC) \$(CFLAGS) -I./include/ -L./.libs/  -lxml2 xzlib.o list.o debugXML.o HTMLparser.o xmlschemas.o xinclude.o xmlsave.o xmlreader.o SAX.o HTMLtree.o xmlschemastypes.o xmlunicode.o schematron.o nanohttp.o xmlregexp.o nanoftp.o catalog.o pattern.o xpointer.o  uri.o threads.o SAX2.o relaxng.o encoding.o entities.o chvalid.o error.o hash.o xmlstring.o valid.o dict.o xmlIO.o xpath.o buf.o xmlmemory.o globals.o parser.o parserInternals.o tree.o  poc.c -o poc -lm -lz -llzma \$(LDFLAGS) \n"  Makefile

